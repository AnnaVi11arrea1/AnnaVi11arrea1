name: Update DEV.to Followers Count

on:
  schedule:
    # Runs at midnight UTC daily
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-count:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Run the update script
        run: |
          # Create a script file inline
          echo '
          const fs = require("fs");
          const https = require("https");

          const API_KEY = process.env.DEVTO_API_KEY;
          const README_FILE = "README.md";
          const START_MARKER = "<!-- DEVTO-FOLLOWERS-COUNT:START -->";
          const END_MARKER = "<!-- DEVTO-FOLLOWERS-COUNT:END -->";

          const getFollowersCount = () => {
            const options = {
              hostname: "dev.to",
              port: 443,
              path: "/api/followers_count,
              method: "GET",
              headers: {
                "api-key": API_KEY,
                "Accept": "application/vnd.forem.api-v1+json"
              },
            };

            return new Promise((resolve, reject) => {
              const req = https.request(options, (res) => {
                let data = "";
                res.on("data", (chunk) => data += chunk);
                res.on("end", () => {
                  if (res.statusCode !== 200) {
                    reject(new Error(`API Error: Status Code ${res.statusCode}. Response: ${data}`));
                    return;
                  }
                  try {
                    const followers = JSON.parse(data);
                    resolve(followers.length); 
                  } catch (e) {
                    reject(new Error(`Failed to parse API response. Response data: ${data}`));
                  }
                });
              });
              req.on("error", reject);
              req.end();
            });
          };

          const updateReadme = async () => {
            try {
              const count = await getFollowersCount();
              let readmeContent = fs.readFileSync(README_FILE, "utf8");
              const newContent = `${START_MARKER}**${count}** DEV.to followers${END_MARKER}`;
              
              const regex = new RegExp(`${START_MARKER}[\\s\\S]*?${END_MARKER}`, "g");
              readmeContent = readmeContent.replace(regex, newContent);

              fs.writeFileSync(README_FILE, readmeContent);
              console.log("README updated with new follower count:", count);
            } catch (error) {
              console.error(error.message);
              // Exit the step with a failure status
              process.exit(1); 
            }
          };

          updateReadme();
          ' > update_script.js

          # Execute the script
          node update_script.js
        env:
          DEVTO_API_KEY: ${{ secrets.DEVTO_API_KEY }}
